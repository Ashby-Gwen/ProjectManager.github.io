<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
    <nav class="navbar">
        <div class="logo">Project Manager</div>
        <ul class="nav-links">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="tasks.html">Tasks</a></li>
        </ul>
    </nav>
</header>

<main>
    <section class="section">
        <h1>Task List</h1>
        <div id="task-container"></div>

        <!-- Add Task Form -->
        <div id="add-task-section">
            <input type="text" id="new-task-name" placeholder="Task name">
            <input type="date" id="new-task-deadline">
            <button id="add-task-btn">Add Task</button>
            <button id="export-csv-btn">Export CSV</button>
        </div>
    </section>

    <section class="section">
        <h1>Upcoming Deadlines</h1>
        <ul id="deadline-list"></ul>
    </section>
</main>

<footer>
    <p>© 2025 Project Manager</p>
</footer>

<script>
const CSV_KEY = "tasks_csv_data";
let tasks = [];

// -----------------------------
// LOAD CSV
// -----------------------------
async function loadCSV() {
    const saved = localStorage.getItem(CSV_KEY);
    if (saved) {
        tasks = JSON.parse(saved);
    } else {
        const response = await fetch("tasks.csv");
        const text = await response.text();
        tasks = parseCSV(text);
        saveTasks();
    }
    renderTasks();
    renderDeadlines();
}

// -----------------------------
// PARSE CSV
// -----------------------------
function parseCSV(csv) {
    const lines = csv.trim().split("\n");
    return lines.slice(1).map(line => {
        const [id, name, deadline, status] = line.split(",");
        return { id, name, deadline, status };
    });
}

// -----------------------------
// SAVE TO LOCALSTORAGE
// -----------------------------
function saveTasks() {
    localStorage.setItem(CSV_KEY, JSON.stringify(tasks));
}

// -----------------------------
// RENDER TASKS
// -----------------------------
function renderTasks() {
    const container = document.getElementById("task-container");
    container.innerHTML = "";

    tasks.forEach(task => {
        const div = document.createElement("div");
        div.className = "task-item";
        div.innerHTML = `
            <input type="checkbox" ${task.status === "Done" ? "checked" : ""} data-id="${task.id}">
            <span class="task-name ${task.status === "Done" ? "done" : ""}">${task.name}</span>
            <span class="deadline">${task.deadline}</span>
        `;
        container.appendChild(div);
    });
    attachCheckboxEvents();
}

// -----------------------------
// CHECKBOX EVENT
// -----------------------------
function attachCheckboxEvents() {
    document.querySelectorAll("input[type='checkbox']").forEach(cb => {
        cb.addEventListener("change", function() {
            const id = this.getAttribute("data-id");
            tasks = tasks.map(task => {
                if (task.id === id) task.status = this.checked ? "Done" : "Pending";
                return task;
            });
            saveTasks();
            renderTasks();
            renderDeadlines();
        });
    });
}

// -----------------------------
// RENDER DEADLINES
// -----------------------------
function renderDeadlines() {
    const list = document.getElementById("deadline-list");
    list.innerHTML = "";

    const now = new Date();
    const upcoming = tasks.filter(task => new Date(task.deadline) >= now && task.status !== "Done");
    upcoming.sort((a,b) => new Date(a.deadline) - new Date(b.deadline));

    upcoming.forEach(task => {
        const li = document.createElement("li");
        li.textContent = `${task.name} — due ${task.deadline}`;
        list.appendChild(li);
    });
}

// -----------------------------
// ADD TASK
// -----------------------------
function addTask(name, deadline) {
    if (!name || !deadline) return alert("Enter task name and deadline!");
    const newTask = {
        id: (tasks.length + 1).toString(),
        name,
        deadline,
        status: "Pending"
    };
    tasks.push(newTask);
    saveTasks();
    renderTasks();
    renderDeadlines();
}

// -----------------------------
// EXPORT CSV
// -----------------------------
function exportCSV() {
    let csv = "ID,Task Name,Deadline,Status\n";
    tasks.forEach(t => { csv += `${t.id},${t.name},${t.deadline},${t.status}\n`; });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "updated_tasks.csv";
    a.click();
}

// -----------------------------
// EVENTS
// -----------------------------
document.getElementById("add-task-btn").addEventListener("click", () => {
    const name = document.getElementById("new-task-name").value;
    const deadline = document.getElementById("new-task-deadline").value;
    addTask(name, deadline);
});

document.getElementById("export-csv-btn").addEventListener("click", exportCSV);

// -----------------------------
// INITIALIZE
// -----------------------------
loadCSV();
</script>
</body>
</html>
